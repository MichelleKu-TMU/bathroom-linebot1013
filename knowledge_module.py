import random
from linebot.v3.messaging import (
    MessagingApi,
    ReplyMessageRequest,
    TextMessage,
    QuickReply,
    QuickReplyItem,
    MessageAction 
)
from linebot.v3.webhooks import MessageEvent
import traceback

# 衛浴安全小知識題庫 (共 50 則)
KNOWLEDGE_CARDS = [
    "💡 防滑墊建議選擇吸盤式或止滑紋理面，並每週清洗一次以防黴菌滋生。",
    "💡 沐浴椅高度應與使用者膝蓋平行，確保坐下時膝關節呈 90 度角。",
    "💡 安裝扶手時，水平扶手適合起身輔助，垂直扶手則有助於穩定身體。",
    "💡 廁所旁建議設置 L 型扶手，能兼顧坐下與站起兩種姿勢的支撐。",
    "💡 浴室地面常濕滑？可鋪設防滑地磚或防水貼條，大幅提升安全性。",
    "💡 沐浴椅材質以鋁合金＋防水塑膠座面最耐用，不易生鏽。",
    "💡 安裝扶手需確認牆面有實心結構，避免螺絲鬆脫造成危險。",
    "💡 浴室照明建議使用防水型 LED，避免陰暗角落造成跌倒，特別是夜間。",
    "💡 若家中有長輩，浴室門可改為外開式，避免跌倒時身體卡門內無法求援。",
    "💡 馬桶太低可加裝增高座或輔助扶手，減少起身負擔和膝關節壓力。",
    "💡 夜間如廁應使用暖色系小夜燈，提供足夠照明，避免強光刺激和跌倒。",
    "💡 洗手台高度應配合使用者，建議可考慮調整式或懸掛式設計，方便輪椅靠近。",
    "💡 浴缸旁加裝階梯扶手，比單一垂直扶手更能協助高齡者安全跨越。",
    "💡 如果無法乾濕分離，可在淋浴區周圍設置止水條，阻止水流外溢，保持環境乾燥。",
    "💡 浴廁緊急求助鈴應安裝在長者容易觸及的高度，最好是防水型並連接至家屬房間。",
    "💡 家裡牆壁是輕隔間？安裝扶手需先請專業人員評估是否需加強支撐結構。",
    "💡 老人或行動不便者，可考慮免治馬桶，省去擦拭動作，如廁更安全衛生。",
    "💡 洗手台下方應淨空，方便輪椅使用者將膝蓋伸入，靠近洗手台。",
    "💡 挑選防滑拖鞋時，除了鞋底紋路，也要注意材質是否會吸水變重或過於僵硬。",
    "💡 浴室內的插座應遠離水源或使用防水蓋，以防觸電。",
    "💡 洗澡前先調整熱水溫度至38–40°C，避免高齡者燙傷。",
    "💡 使用帶扶手的可旋轉洗臉椅，方便長者坐下或站起時保持平衡。",
    "💡 浴室內應保持良好照明，尤其是夜間使用時，避免強烈陰影影響判斷。",
    "💡 安裝防水扶手時，務必固定在實心牆或加強支撐板上，確保承重安全。",
    "💡 浴室門可改為外開式，避免跌倒時卡住門內，方便家人救援。",
    "💡 浴室地面鋪防滑墊或止滑磁磚，可有效降低滑倒風險。",
    "💡 將常用洗浴用品放在伸手可及高度，避免高處取物造成失衡。",
    "💡 沐浴椅高度應與使用者膝蓋平行，確保坐下時膝關節呈90度角。",
    "💡 若浴室無乾濕分離，可在淋浴區周圍設置止水條，保持地面乾燥。",
    "💡 安裝感應小夜燈或暖色系夜燈，夜間如廁時提供足夠照明，降低跌倒機率。",
    "💡 定期檢查防滑墊、扶手及沐浴椅是否鬆動或破損，確保安全可靠。",
    "💡 浴室內不要堆放雜物，保持走道寬敞，減少絆倒風險。",
    "💡 使用防水、防霉拖鞋，避免腳底打滑，並保持腳部乾爽。",
    "💡 馬桶旁可加裝增高座或扶手，幫助長者起身減輕膝關節負擔。",
    "💡 洗手台下方保持淨空，方便輪椅或助行器靠近，增加使用便利。",
    "💡 浴室牆角可加裝角落扶手，提供額外支撐，尤其是長者進出淋浴區時。",
    "💡 衛浴電源插座應遠離水源，或使用防水蓋，避免觸電。",
    "💡 浴室內可設置緊急求助鈴，連接至家屬房間，方便即時呼救。",
    "💡 若牆面是輕隔間，安裝扶手前請專業人員評估承重，確保安全。",
    "💡 定期清潔沐浴椅與扶手，避免黴菌滋生或表面滑動，維持安全衛生。",
    "💡 浴室門把手建議使用 D 型把手，握持更舒適且防滑。",
    "💡 浴室置物架應固定牢固，避免拿取用品時搖晃導致跌倒。",
    "💡 長者使用淋浴時可在地面貼防滑貼紙，增加摩擦力。",
    "💡 淋浴時避免一次倒太多水，保持地面乾燥，減少滑倒風險。",
    "💡 在浴室門口放置吸水腳踏墊，防止水花滑到地面。",
    "💡 安裝可調高度花灑，避免長者手臂過度抬高，降低疲勞與危險。",
    "💡 定期檢查浴室排水，避免積水成為滑倒隱患。",
    "💡 家中若有多位長者，可為不同使用者設計專屬座椅或扶手高度，增加舒適與安全。",
    "💡 浴室天花板最好裝防潮燈具，防止燈具因潮濕而故障或滴水。",
    "💡 若浴室空間有限，可選擇折疊沐浴椅，使用時打開，不用時收納不占空間。",
    "💡 浴室牆面可貼防滑牆貼或防水板，增加摩擦力並保護牆面。"
]

# Quick Reply 選單
QUICK_REPLY_WIDGET = QuickReply(items=[
    QuickReplyItem(
        action=MessageAction(label="🔁 再來一張", text="小知識")
    ),
    QuickReplyItem(
        action=MessageAction(label="📍 找最近的中心", text="附近輔具資源")
    )
])

def handle_knowledge_quiz(event: MessageEvent, line_bot_api: MessagingApi):
    """
    隨機選擇一個衛浴安全小知識並回覆給使用者，附帶 Quick Reply 選單。
    """
    try:
        # 隨機選擇一個小知識
        knowledge_card = random.choice(KNOWLEDGE_CARDS)

        # 組合回覆訊息
        reply_text = f"✨ 小知識來囉！\n\n{knowledge_card}"

        # 發送訊息
        line_bot_api.reply_message(
            ReplyMessageRequest(
                reply_token=event.reply_token,
                messages=[
                    TextMessage(
                        text=reply_text,
                        quick_reply=QUICK_REPLY_WIDGET
                    )
                ]
            )
        )
    except Exception as e:
        traceback.print_exc()
        # 錯誤處理：發送一個簡單的錯誤訊息
        line_bot_api.reply_message(
            ReplyMessageRequest(
                reply_token=event.reply_token,
                messages=[TextMessage(text="抱歉，小知識功能發生錯誤，請稍後再試。")]
            )
        )
